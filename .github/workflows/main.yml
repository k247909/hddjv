name: Persistent RDP Environment

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # يشغل نفسه كل 6 ساعات

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Initialize RDP
      run: |
        echo "[+] Starting RDP Environment..."
        choco install googlechrome -y
        mkdir C:\Users\runneradmin\workdir
        echo "[OK] Base environment ready."

    - name: Install Rclone
      run: |
        choco install rclone -y

    - name: Configure Rclone
      run: |
        echo "[+] Configuring Rclone..."
        rclone config file
        echo "👉 أدخل إعداد Google Drive يدوياً أثناء التشغيل الأول فقط."

    - name: Restore Snapshot from Google Drive
      run: |
        echo "[🔁] Checking for previous snapshot..."
        rclone copy gdrive:/rdp_snapshots/myenv.tar.gz C:\Users\runneradmin\Desktop\ || echo "No previous backup found."
        cd C:\Users\runneradmin\
        tar -xzf Desktop\myenv.tar.gz || echo "No archive to extract."
        echo "[✅] Environment restored successfully."

    - name: Start Remote Desktop
      run: |
        echo "[🚀] Launching RDP..."
        powershell -Command "Invoke-WebRequest -Uri https://github.com/stascorp/rdpwrap/releases/download/v1.6.2/rdpwrap.zip -OutFile rdpwrap.zip"
        powershell -Command "Expand-Archive rdpwrap.zip -DestinationPath .\rdpwrap"
        cd rdpwrap
        install.bat
        echo "Username: runneradmin"
        echo "Password: admin"
        echo "[🔓] Connect to RDP with ngrok or Cloudflare Tunnel."

    - name: Backup Before Shutdown
      if: always()
      run: |
        echo "[💾] Saving environment snapshot..."
        cd C:\Users\runneradmin\
        tar -czf myenv.tar.gz workdir
        rclone copy myenv.tar.gz gdrive:/rdp_snapshots/ -P
        echo "[✅] Snapshot uploaded successfully."
