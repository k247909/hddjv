name: Persistent RDP Environment

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # ÙŠØ´ØºÙ„ Ù†ÙØ³Ù‡ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Initialize RDP
      run: |
        echo "[+] Starting RDP Environment..."
        choco install googlechrome -y
        mkdir C:\Users\runneradmin\workdir
        echo "[OK] Base environment ready."

    - name: Install Rclone
      run: |
        choco install rclone -y

    - name: Configure Rclone
      run: |
        echo "[+] Configuring Rclone..."
        rclone config file
        echo "ğŸ‘‰ Ø£Ø¯Ø®Ù„ Ø¥Ø¹Ø¯Ø§Ø¯ Google Drive ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ ÙÙ‚Ø·."

    - name: Restore Snapshot from Google Drive
      run: |
        echo "[ğŸ”] Checking for previous snapshot..."
        rclone copy gdrive:/rdp_snapshots/myenv.tar.gz C:\Users\runneradmin\Desktop\ || echo "No previous backup found."
        cd C:\Users\runneradmin\
        tar -xzf Desktop\myenv.tar.gz || echo "No archive to extract."
        echo "[âœ…] Environment restored successfully."

    - name: Start Remote Desktop
      run: |
        echo "[ğŸš€] Launching RDP..."
        powershell -Command "Invoke-WebRequest -Uri https://github.com/stascorp/rdpwrap/releases/download/v1.6.2/rdpwrap.zip -OutFile rdpwrap.zip"
        powershell -Command "Expand-Archive rdpwrap.zip -DestinationPath .\rdpwrap"
        cd rdpwrap
        install.bat
        echo "Username: runneradmin"
        echo "Password: admin"
        echo "[ğŸ”“] Connect to RDP with ngrok or Cloudflare Tunnel."

    - name: Backup Before Shutdown
      if: always()
      run: |
        echo "[ğŸ’¾] Saving environment snapshot..."
        cd C:\Users\runneradmin\
        tar -czf myenv.tar.gz workdir
        rclone copy myenv.tar.gz gdrive:/rdp_snapshots/ -P
        echo "[âœ…] Snapshot uploaded successfully."
