# SHADOWHACKER-GOD: RDP Workflow (Stable RustDesk FINAL Version)
# Auto-installs RustDesk, sets unattended password, retrieves ID reliably, and manages Gist data.

name: AEON-RDP-RUSTDESK-FINAL-STABLE

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - uses: actions/checkout@v3
    
    # 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ© ÙˆØ§Ù„Ø¨ÙŠØ¦Ø©
    - name: Setup Environment Variables
      run: |
        Write-Host "--- Loading Environment Variables and Secrets ---"
        echo "RUSTDESK_PASS=${{ secrets.RUSTDESK_PASSWORD }}" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "PERSISTENT_DIR=C:\Users\runneradmin\PersistentData" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "GIST_TOKEN=${{ secrets.GIST_TOKEN }}" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "GIST_ID=${{ secrets.GIST_ID }}" | Out-File -FilePath $env:GITHUB_ENV -Append
        # Ù…ØªØºÙŠØ± Ù„Ù„Ø¥ØµØ¯Ø§Ø±
        echo "RD_VERSION=1.2.6" | Out-File -FilePath $env:GITHUB_ENV -Append
      shell: powershell

    # 2. ØªØ«Ø¨ÙŠØª Python (Ù„Ø­ÙØ¸/Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
    - name: Install Python Libraries for Gist Access
      run: pip install requests
      shell: cmd

    # 3. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø§Ø¦Ù…Ø© (Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ID Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆØ¬Ø¯)
    - name: Restore Persistent Data from Gist
      run: |
        mkdir $env:PERSISTENT_DIR -Force
        # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù„Ù restore_data.py
        python ./scripts/restore_data.py $env:GIST_ID $env:GIST_TOKEN $env:PERSISTENT_DIR
      shell: pwsh

    # 4. ØªØ«Ø¨ÙŠØª RustDesk Ø¨ØµÙ…Øª (Ù…ÙØ­Ø³Ù‘ÙÙ†)
    - name: Install RustDesk Silently (Reliable)
      run: |
        Write-Host "=== Installing RustDesk (Reliable Method) ==="
        $version = $env:RD_VERSION
        $exeUrl = "https://github.com/rustdesk/rustdesk/releases/download/$version/rustdesk-$version-x86_64.exe"
        $exePath = "$env:TEMP\rustdesk-$version-x86_64.exe"
        
        Write-Host "Downloading RustDesk $version..."
        Invoke-WebRequest -Uri $exeUrl -OutFile $exePath -UseBasicParsing

        Write-Host "Running silent installer..."
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… -Wait ÙŠØ¶Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø­ØªÙ‰ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ù…Ø«Ø¨Øª
        Start-Process -FilePath $exePath -ArgumentList "--silent-install" -Wait
        Start-Sleep -Seconds 10 # Ø¥Ø¹Ø·Ø§Ø¡ Ù…Ù‡Ù„Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø®Ø¯Ù…Ø©

        # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ (RustDesk ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ«Ø¨Øª ÙÙŠ Program Files Ø£Ùˆ AppData)
        $defaultPath = "$env:ProgramFiles\RustDesk\rustdesk.exe"
        $userPath = "$env:AppData\RustDesk\rustdesk.exe"
        $rustdeskExe = $null

        if (Test-Path $defaultPath) { $rustdeskExe = $defaultPath }
        elseif (Test-Path $userPath) { $rustdeskExe = $userPath }
        
        if (-not $rustdeskExe) {
          Write-Error "CRITICAL: RustDesk executable not found after install in expected paths."
          exit 1
        }

        echo "RUSTDESK_EXE=$rustdeskExe" | Out-File -FilePath $env:GITHUB_ENV -Append
        Write-Host "RustDesk installed successfully at $rustdeskExe"
      shell: powershell

    # 5. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©
    - name: Wait for RustDesk Service to be Ready
      run: |
        Write-Host "=== Ensuring RustDesk service is running ==="
        $serviceNames = @("RustDesk","rustdesk")
        $maxWait = 120
        $wait = 0
        $found = $false
        
        # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø®Ø¯Ù…Ø© ÙˆØ§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ 120 Ø«Ø§Ù†ÙŠØ©
        while ($wait -lt $maxWait -and -not $found) {
            foreach ($s in $serviceNames) {
                $svc = Get-Service -Name $s -ErrorAction SilentlyContinue
                if ($svc) {
                    if ($svc.Status -ne 'Running') { 
                        Write-Host "Starting service '$($svc.Name)'..."
                        Start-Service -Name $svc.Name -ErrorAction SilentlyContinue 
                    }
                    $found = $true
                    break
                }
            }
            if (-not $found) { Start-Sleep -Seconds 5; $wait += 5 }
        }

        if (-not $found) {
            Write-Warning "RustDesk service not detected or ready after $maxWait seconds. This might affect ID retrieval."
        } else {
            Write-Host "RustDesk service is running."
        }
      shell: powershell

    # 6. Ø¥Ø¹Ø¯Ø§Ø¯ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ÙˆØµÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ID (Ù…ÙØ­Ø³Ù‘ÙÙ†)
    - name: Configure RustDesk and Retrieve ID
      run: |
        Write-Host "=== Configuring RustDesk Unattended Access ==="
        $rustdeskExe = $env:RUSTDESK_EXE
        $rdPass = $env:RUSTDESK_PASS

        if (-not (Test-Path $rustdeskExe)) {
            Write-Error "CRITICAL: RustDesk executable not found: $rustdeskExe"
            exit 1
        }

        # 6.1 ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        Write-Host "Setting permanent password..."
        & $rustdeskExe --password $rdPass
        Write-Host "Password set."
        Start-Sleep -Seconds 10 # Ø§Ù†ØªØ¸Ø§Ø± Ù„ØªØ·Ø¨ÙŠÙ‚ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±

        # 6.2 Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù€ ID (20 Ù…Ø­Ø§ÙˆÙ„Ø© * 5 Ø«ÙˆØ§Ù†ÙŠ = 100 Ø«Ø§Ù†ÙŠØ©)
        Write-Host "Retrieving RustDesk ID..."
        $rdID = $null
        $attempts = 0
        while (-not $rdID -and $attempts -lt 20) {
            # Ø¥Ù‡Ù…Ø§Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªÙŠ Ù‚Ø¯ ØªØ¸Ù‡Ø± Ù…Ù† --get-id
            $output = & $rustdeskExe --get-id 2>$null 
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù†Ø§ØªØ¬ Ù‡Ùˆ Ø±Ù‚Ù… ID ØµØ­ÙŠØ­ (9 Ø£Ø±Ù‚Ø§Ù…)
            if ($output -match '^\d{9}$') {
                $rdID = $output.Trim()
                break
            }
            
            Write-Host "Waiting for RustDesk ID to register with server... ($($attempts+1)/20)"
            Start-Sleep -Seconds 5
            $attempts++
        }

        if (-not $rdID) {
            Write-Error "CRITICAL: RustDesk ID could not be retrieved after multiple attempts. Access will fail."
            exit 1
        }

        # 6.3 Ø­ÙØ¸ Ø§Ù„Ù€ ID ÙÙŠ Ø§Ù„Ø¨ÙŠØ¦Ø© ÙˆÙÙŠ Gist
        echo "RUSTDESK_ID=$rdID" | Out-File -FilePath $env:GITHUB_ENV -Append
        "$rdID" | Out-File -FilePath "$env:PERSISTENT_DIR\rustdesk_id.txt" -Force

        Write-Host "RustDesk ID: $rdID"
        Write-Host "=== Configuration Complete ==="
      shell: powershell

    # 7. Ø·Ø¨Ø§Ø¹Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
    - name: Display Connection Info
      run: |
        Write-Output "----------------------------------------------"
        Write-Output "  ğŸ” RustDesk Remote Access Information"
        Write-Output "----------------------------------------------"
        Write-Output "ID: $env:RUSTDESK_ID"
        Write-Output "Password: ${{ secrets.RUSTDESK_PASSWORD }}"
        Write-Output "----------------------------------------------"
        Write-Output "ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ù… RustDesk Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙˆØ£Ø¯Ø®Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§ØªØµØ§Ù„"
      shell: powershell

    # 8. Ø­Ù„Ù‚Ø© Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø¥ØºÙ„Ø§Ù‚ (Keep Alive)
    - name: Final Keep Alive Loop and Data Save
      run: |
        Write-Host "Keeping session alive for 5h 50m..."
        Start-Sleep -Seconds 21000 # 350 minutes
        
        Write-Host "--- Executing final data save to Gist ---"
        # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù„Ù save_data.py Ù„Ø±ÙØ¹ rustdesk_id.txt ÙˆØ¨Ù‚ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        python ./scripts/save_data.py $env:GIST_ID $env:GIST_TOKEN $env:PERSISTENT_DIR
        
        # Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø®Ø¯Ù…Ø© Ù‚Ø¨Ù„ Ø¥ØºÙ„Ø§Ù‚ runner
        Stop-Service -Name "RustDesk" -ErrorAction SilentlyContinue
        
        Write-Host "Data saved successfully. Shutting down."
      shell: powershell
