name: secure-rdp

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: ğŸ§© Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…Ù„
      run: |
        Write-Host "ğŸ”§ Ø¨Ø¯Ø¡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯..."
        mkdir $env:PERSISTENT_DIR -Force
        Write-Host "ğŸ“ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø§Ø¦Ù…Ø©."
      shell: powershell
      env:
        PERSISTENT_DIR: C:\Users\TOOLBOXLAP\PersistentData

    - name: ğŸ›¡ï¸ ØªØ«Ø¨ÙŠØª Tailscale
      run: |
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
        $tsPath = "$env:TEMP\tailscale.msi"
        Invoke-WebRequest $tsUrl -OutFile $tsPath -UseBasicParsing
        Start-Process msiexec.exe -Wait -ArgumentList "/i `"$tsPath`" /qn"
        Write-Host "âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Tailscale Ø¨Ù†Ø¬Ø§Ø­."
      shell: powershell

    - name: ğŸ§° ØªØ«Ø¨ÙŠØª AnyDesk Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø°ÙƒÙŠØ© Ù„Ù„Ø£Ø®Ø·Ø§Ø¡
      run: |
        Write-Host "ğŸš€ Ø¨Ø¯Ø¡ ØªØ«Ø¨ÙŠØª AnyDesk..."

        $ErrorActionPreference = "Continue"
        $logFile = "C:\Users\TOOLBOXLAP\PersistentData\AnyDeskPath.txt"
        if (!(Test-Path "C:\Users\TOOLBOXLAP\PersistentData")) {
            New-Item -ItemType Directory -Path "C:\Users\TOOLBOXLAP\PersistentData" | Out-Null
        }

        function Test-ADExe {
            param($path)
            return (Test-Path $path)
        }

        # --- Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 1: ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø³Ù…ÙŠ ---
        try {
            $url = "https://download.anydesk.com/AnyDesk.exe"
            $output = "$env:TEMP\AnyDesk.exe"
            Write-Host "â¬‡ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ†Ø²ÙŠÙ„ AnyDesk Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø³Ù…ÙŠ..."
            Invoke-WebRequest $url -OutFile $output -UseBasicParsing -ErrorAction Stop
            if (Test-ADExe $output) {
                Write-Host "âœ… ØªÙ… ØªÙ†Ø²ÙŠÙ„ AnyDesk Ù…Ø¨Ø§Ø´Ø±Ø©."
                $ADExePath = $output
            }
        } catch {
            Write-Warning "âš  ÙØ´Ù„ Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±. Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… winget/choco."
        }

        # --- Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 2: Winget ---
        if (-not (Test-Path $ADExePath)) {
            try {
                Write-Host "ğŸ’¿ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ«Ø¨ÙŠØª AnyDesk Ø¹Ø¨Ø± Winget..."
                winget install --id AnyDeskSoftwareGmbH.AnyDesk -e --accept-source-agreements --accept-package-agreements -h
            } catch {
                Write-Warning "âš  Winget ÙØ´Ù„. Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Chocolatey."
            }
        }

        # --- Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 3: Chocolatey ---
        if (-not (Test-Path $ADExePath)) {
            try {
                Write-Host "ğŸ« Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ«Ø¨ÙŠØª AnyDesk Ø¹Ø¨Ø± Chocolatey..."
                choco install anydesk -y --force
            } catch {
                Write-Warning "âš  ÙØ´Ù„ Chocolatey."
            }
        }

        # --- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ«Ø¨ÙŠØª ---
        Write-Host "ğŸ” ÙØ­Øµ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù…ÙƒÙ†Ø© Ù„Ù€ AnyDesk..."
        $ADExePath = $null
        $possiblePaths = @(
            "C:\ProgramData\chocolatey\bin\AnyDesk.exe",
            "C:\ProgramData\chocolatey\lib\anydesk.portable\tools\AnyDesk.exe",
            "C:\ProgramData\chocolatey\lib\anydesk\tools\AnyDesk.exe",
            "$env:ProgramFiles\AnyDesk\AnyDesk.exe",
            "$env:ProgramFiles(x86)\AnyDesk\AnyDesk.exe",
            "$env:LocalAppData\Programs\AnyDesk\AnyDesk.exe"
        )

        foreach ($p in $possiblePaths) {
            if (Test-ADExe $p) {
                Write-Host "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ AnyDesk ÙÙŠ: $p"
                $ADExePath = $p
                break
            }
        }

        # --- Ø¨Ø­Ø« Ø¹Ù…ÙŠÙ‚ Ù„Ùˆ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± ---
        if (-not $ADExePath) {
            Write-Host "ğŸ§­ Ø¨Ø­Ø« Ø´Ø§Ù…Ù„ ÙÙŠ Ù…Ø¬Ù„Ø¯ Chocolatey..."
            $found = Get-ChildItem "C:\ProgramData\chocolatey" -Filter "AnyDesk.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($found) {
                $ADExePath = $found.FullName
                Write-Host "âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ AnyDesk ÙÙŠ: $ADExePath"
            }
        }

        # --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙØ´Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ---
        if (-not $ADExePath) {
            Write-Error "âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ AnyDesk Ø¨Ø¹Ø¯ Ø§Ù„ØªØ«Ø¨ÙŠØª. Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØªÙˆÙ‚ÙØª."
            exit 1
        }

        # --- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø± ÙÙŠ Ù…Ù„Ù Ù†ØµÙŠ ---
        Write-Host "ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø± ÙÙŠ $logFile"
        "AnyDeskPath=$ADExePath" | Out-File -FilePath $logFile -Encoding UTF8 -Force

        # --- Ø¥Ø¹Ø¯Ø§Ø¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆID ---
        try { & "$ADExePath" --set-password $env:ANYDESK_PASS } catch { Write-Warning "âš  ÙØ´Ù„ ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±." }
        Start-Sleep -Seconds 5
        try {
            $id = & "$ADExePath" --get-id
            if ($id) {
                echo "ANYDESK_ID=$id" | Out-File -FilePath $env:GITHUB_ENV -Append
                Write-Host "ğŸ†” AnyDesk ID: $id"
            } else {
                Write-Warning "âš  Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ AnyDesk ID."
            }
        } catch {
            Write-Warning "âš  ÙØ´Ù„ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ID."
        }

        Write-Host "ğŸ¯ ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­."
      shell: powershell
      env:
        ANYDESK_PASS: "123456"

    - name: âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
      run: |
        Write-Host "ğŸ‰ ÙƒÙ„ Ø´ÙŠØ¡ ØªÙ… Ø¨Ù†Ø¬Ø§Ø­! AnyDesk Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„."
        Get-Content "C:\Users\TOOLBOXLAP\PersistentData\AnyDeskPath.txt"
      shell: powershell
