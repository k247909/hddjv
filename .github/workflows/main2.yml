# SHADOWHACKER-GOD: RDP Workflow (Robust AnyDesk Install with Fallbacks & Timeouts)

name: AEON-RDP-TAILSCALE-ANYDESK

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - uses: actions/checkout@v3

    # 1. إعداد المتغيرات السرية والبيئة
    - name: Setup Secrets and Environment Variables
      run: |
        echo "RDP_PASS=${{ secrets.RDP_PASSWORD }}" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "RDP_USER=TOOLBOXLAP" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "ANYDESK_PASS=${{ secrets.ANYDESK_PASSWORD }}" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "PERSISTENT_DIR=C:\Users\TOOLBOXLAP\PersistentData" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "GIST_TOKEN=${{ secrets.GIST_TOKEN }}" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "GIST_ID=${{ secrets.GIST_ID }}" | Out-File -FilePath $env:GITHUB_ENV -Append
      shell: powershell

    # 2. تثبيت مكتبة requests
    - name: Install Python Libraries for Gist Access
      run: pip install requests
      shell: cmd

    # 3. استعادة البيانات الدائمة من Gist
    - name: Restore Persistent Data from Gist
      run: |
        mkdir $env:PERSISTENT_DIR -Force
        python ./scripts/restore_data.py $env:GIST_ID $env:GIST_TOKEN $env:PERSISTENT_DIR
      shell: pwsh

    # 4. تثبيت Tailscale (Stable MSI Method)
    - name: Install Tailscale (Stable MSI Method)
      run: |
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
        Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
        Remove-Item $installerPath -Force
        Start-Sleep -Seconds 5
      shell: powershell

    # 5. توصيل Tailscale والحصول على IP
    - name: Establish Tailscale Connection & Get IP
      run: |
        $TailscaleExe = "$env:ProgramFiles\Tailscale\tailscale.exe"
        & $TailscaleExe up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=AEON-RDP-WIN-$env:GITHUB_RUN_ID
        $tsIP = $null
        $retries = 0
        while (-not $tsIP -and $retries -lt 15) {
            $tsIP = & $TailscaleExe ip -4
            Start-Sleep -Seconds 5
            $retries++
        }
        if (-not $tsIP) {
            Write-Error "Tailscale IP not assigned. Exiting."
            exit 1
        }
        echo "TAILSCALE_IP=$tsIP" | Out-File -FilePath $env:GITHUB_ENV -Append
      shell: powershell

    # 6. تثبيت وتكوين AnyDesk (متعدد المحاولات، مع مهلة)
    - name: Install and Configure AnyDesk (robust, non-blocking)
      run: |
        # minimal helper functions
        function Invoke-Download {
            param($url, $outPath)
            try {
                Write-Host "Downloading: $url -> $outPath"
                Invoke-WebRequest -Uri $url -OutFile $outPath -UseBasicParsing -ErrorAction Stop
                return $true
            } catch {
                Write-Warning "Download failed: $($_.Exception.Message)"
                return $false
            }
        }

        $tempDir = "$env:TEMP\AnyDesk"
        New-Item -Path $tempDir -ItemType Directory -Force | Out-Null
        $msiUrl = "https://download.anydesk.com/AnyDesk.msi"
        $msiPath = Join-Path $tempDir "AnyDesk.msi"

        # 1) Try MSI download & silent install with timeout
        $downloaded = Invoke-Download -url $msiUrl -outPath $msiPath
        $installed = $false

        if ($downloaded) {
            Write-Host "Installing AnyDesk MSI via msiexec (silent, 180s timeout)..."
            $msiProcess = Start-Process -FilePath "msiexec.exe" -ArgumentList "/i", "`"$msiPath`"", "/qn", "/norestart" -PassThru
            $timeoutSeconds = 180
            $sw = [diagnostics.stopwatch]::StartNew()
            while (-not $msiProcess.HasExited -and $sw.Elapsed.TotalSeconds -lt $timeoutSeconds) {
                Start-Sleep -Seconds 2
            }
            if (-not $msiProcess.HasExited) {
                try { $msiProcess.Kill() } catch {}
                Write-Error "msiexec did not exit within $timeoutSeconds seconds and was killed. Aborting install attempt."
                # بدلاً من exit 1 هنا، نستمر في المحاولات الأخرى
            } else {
                Write-Host "msiexec exited with code $($msiProcess.ExitCode)"
                if ($msiProcess.ExitCode -eq 0) { $installed = $true } else { Write-Warning "msiexec returned non-zero exit code ($($msiProcess.ExitCode))." }
            }
        } else {
            Write-Warning "MSI download failed; will try winget/choco as fallback."
        }

        # 2) winget fallback
        if (-not $installed) {
            try {
                $winget = Get-Command winget -ErrorAction SilentlyContinue
                if ($winget) {
                    Write-Host "Attempting winget install (180s timeout)..."
                    $p = Start-Process -FilePath "winget" -ArgumentList "install --silent --accept-package-agreements --accept-source-agreements AnyDesk.AnyDesk" -PassThru -NoNewWindow
                    $p.WaitForExit(180000)
                    if (-not $p.HasExited) { $p.Kill(); throw "winget timed out" }
                    if ($p.ExitCode -eq 0) { $installed = $true } else { Write-Warning "winget exit code $($p.ExitCode)" }
                } else {
                    Write-Warning "winget not available on runner."
                }
            } catch {
                Write-Warning "winget install failed: $($_.Exception.Message)"
            }
        }

        # 3) choco fallback
        if (-not $installed) {
            try {
                $choco = Get-Command choco -ErrorAction SilentlyContinue
                if ($choco) {
                    Write-Host "Attempting choco install (240s timeout)..."
                    $p = Start-Process -FilePath "choco" -ArgumentList "install anydesk -y --no-progress" -PassThru -NoNewWindow
                    $p.WaitForExit(240000)
                    if (-not $p.HasExited) { $p.Kill(); throw "choco timed out" }
                    if ($p.ExitCode -eq 0) { $installed = $true } else { Write-Warning "choco exit code $($p.ExitCode)" }
                } else {
                    Write-Warning "choco not available on runner."
                }
            } catch {
                Write-Warning "choco install failed: $($_.Exception.Message)"
            }
        }

        # 4) Locate AnyDesk.exe
        if (-not $installed) {
             Write-Error "All AnyDesk install methods failed. AnyDesk will be unavailable. Proceeding with Tailscale."
             echo "ANYDESK_ID=INSTALL_FAILED" | Out-File -FilePath $env:GITHUB_ENV -Append
        }
        
        $possibleRoots = @("$env:ProgramFiles\AnyDesk", "${env:ProgramFiles(x86)}\AnyDesk", $env:ProgramFiles, ${env:ProgramFiles(x86)}) # تم تصحيح الصيغة النحوية
        $ADExePath = $null
        foreach ($root in $possibleRoots | Where-Object { $_ -ne $null }) {
            try {
                # البحث المباشر
                $candidate = Join-Path $root "AnyDesk.exe"
                if (Test-Path $candidate) { $ADExePath = $candidate; break }
                # بحث أعمق
                $found = Get-ChildItem -Path $root -Filter "AnyDesk.exe" -Recurse -Depth 2 -ErrorAction SilentlyContinue | Select-Object -First 1
                if ($found) { $ADExePath = $found.FullName; break }
            } catch {}
        }

        if (-not $ADExePath) {
            Write-Warning "AnyDesk.exe not found after all install attempts. AnyDesk ID will be NOT_AVAILABLE."
            echo "ANYDESK_ID=NOT_AVAILABLE" | Out-File -FilePath $env:GITHUB_ENV -Append
            # نخرج بنجاح للحفاظ على سير العمل
            exit 0
        }

        Write-Host "Found AnyDesk at: $ADExePath"

        # 5) Try to set unattended access password via CLI (best-effort)
        try {
            Write-Host "Attempting to set AnyDesk password via CLI..."
            & "$ADExePath" --set-password $env:ANYDESK_PASS 2>&1 | Out-Null
            Start-Sleep -Seconds 3
        } catch {
            Write-Warning "Setting AnyDesk password via CLI failed: $($_.Exception.Message)"
        }

        # 6) Get AnyDesk ID with retries (best-effort - لا يفشل السير العمل)
        $ADID = $null
        $retries = 0
        Write-Host "Attempting to retrieve AnyDesk ID (Max 60s Wait)..."
        while (-not $ADID -and $retries -lt 12) {
            try {
                $raw = & "$ADExePath" --get-id 2>$null # تجاهل رسائل الخطأ 2>/dev/null
                if ($raw) {
                    if ($raw -match '\d{6,12}') { $ADID = $Matches[0] } else { $ADID = $raw.Trim() }
                }
            } catch {}
            if (-not $ADID) { Start-Sleep -Seconds 5 }
            $retries++
        }

        if ($ADID) {
            Write-Host "SUCCESS: AnyDesk ID: $ADID"
            echo "ANYDESK_ID=$ADID" | Out-File -FilePath $env:GITHUB_ENV -Append
        } else {
            Write-Warning "Could not retrieve AnyDesk ID after multiple attempts. Assuming network block. Continuing."
            echo "ANYDESK_ID=NOT_AVAILABLE" | Out-File -FilePath $env:GITHUB_ENV -Append
        }
        
      shell: powershell

    # 7. تكوين RDP و إنشاء المستخدم
    - name: Configure RDP User and Set Password
      run: |
        $password = $env:RDP_PASS
        $securePass = ConvertTo-SecureString $password -AsPlainText -Force

        if (-not (Get-LocalUser -Name "$env:RDP_USER" -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name "$env:RDP_USER" -Password $securePass -AccountNeverExpires
        }

        Add-LocalGroupMember -Group "Administrators" -Member "$env:RDP_USER"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "$env:RDP_USER"

        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        Restart-Service -Name TermService -Force
      shell: powershell

    # 8. طباعة بيانات الاتصال
    - name: Display Connection Details
      run: |
        $ADID = $env:ANYDESK_ID
        if (-not $ADID) { $ADID = "NOT_AVAILABLE" } # لضمان عرض قيمة في حالة عدم تعيينها

        Write-Host "--------------------------------------------------------"
        Write-Host "          SHADOWHACKER-GOD: DUAL CONNECTION INFO         "
        Write-Host "--------------------------------------------------------"
        Write-Host "   A. اتصال RDP عبر Tailscale (الحل المؤكد):"
        Write-Host "      - المستخدم (User): $env:RDP_USER"
        Write-Host "      - كلمة مرور RDP (Password): ${{ secrets.RDP_PASSWORD }}"
        Write-Host "      - عنوان IP (IP/Address): $env:TAILSCALE_IP"
        Write-Host "--------------------------------------------------------"
        Write-Host "   B. اتصال AnyDesk (الاحتياطي):"
        Write-Host "      - مُعرِّف AnyDesk (ID): $ADID"
        Write-Host "      - كلمة مرور AnyDesk (Password): ${{ secrets.ANYDESK_PASSWORD }}"
        Write-Host "      **ملاحظة: إذا كان ID هو 'NOT_AVAILABLE' أو 'INSTALL_FAILED'، استخدم Tailscale فقط**"
        Write-Host "--------------------------------------------------------"
      shell: powershell

    # 9. حلقة الحفظ والإغلاق (للحفظ الآمن قبل 5h 50m)
    - name: Keep Alive and Data Sync Loop (Safe Shutdown)
      run: |
        Start-Sleep -Seconds 21000
        Write-Host "--- Executing final data save to Gist (5h 50m mark) ---"
        python ./scripts/save_data.py $env:GIST_ID $env:GIST_TOKEN $env:PERSISTENT_DIR
        Write-Host "Data saved successfully. Shutting down. Auto-restart imminent."
      shell: powershell
